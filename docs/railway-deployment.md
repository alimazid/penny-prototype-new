# Railway Deployment Guide

## Quick Setup

### 1. Create Railway Project
1. Go to [railway.app](https://railway.app)
2. Sign up/login with GitHub
3. Click "New Project" â†’ "Deploy from GitHub repo"
4. Select `penny-prototype-new` repository
5. Railway will automatically detect Node.js and start building

### 2. Add Required Services
Click "Add Service" to add:
- **PostgreSQL** (click PostgreSQL template)
- **Redis** (click Redis template)

### 3. Environment Variables Setup

Railway will automatically provide `DATABASE_URL` and `REDIS_URL` from the services above.

**Required Variables to Add:**

#### Core API Keys
```bash
OPENAI_API_KEY=sk-proj-your-openai-key-here
GOOGLE_CLIENT_ID=your-google-client-id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your-google-client-secret
```

#### Security & Sessions
```bash
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production
SESSION_SECRET=session-secret-change-this-in-production
```

#### Application Configuration
```bash
NODE_ENV=development
PORT=3000
HOST=0.0.0.0
LOG_LEVEL=debug
```

#### Gmail Configuration
```bash
GOOGLE_REDIRECT_URI=https://your-railway-app.railway.app/auth/google/callback
TEST_GMAIL_ADDRESS=your-test-email@gmail.com
```

#### Feature Flags
```bash
USE_SAMPLE_EMAILS=true
SAMPLE_EMAIL_COUNT=20
ENABLE_REQUEST_LOGGING=true
```

### 4. Branch-Based Deployment

#### Development Environment
- **Branch**: `dev`
- **Auto-deploy**: Enabled
- **Environment**: Development

#### Setup Branch Protection:
1. Go to GitHub repository settings
2. Add branch protection rule for `main`
3. Require pull requests before merging

### 5. Domain Configuration
Railway provides a custom domain like `penny-prototype-dev.railway.app`

Update your Google OAuth settings:
- Add Railway domain to authorized redirect URIs
- Update `GOOGLE_REDIRECT_URI` environment variable

## Environment Variables Reference

### Auto-Generated by Railway
```bash
DATABASE_URL=postgresql://username:password@host:port/database
REDIS_URL=redis://host:port
RAILWAY_ENVIRONMENT=development
```

### Required User Configuration
```bash
# AI Services
OPENAI_API_KEY=sk-proj-...
OPENAI_ORGANIZATION_ID=  # Optional

# Google OAuth (Gmail API)
GOOGLE_CLIENT_ID=....apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=GOCSPX-...
GOOGLE_REDIRECT_URI=https://your-app.railway.app/auth/google/callback

# Security
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production
JWT_EXPIRES_IN=24h
SESSION_SECRET=session-secret-change-this-in-production
SESSION_MAX_AGE=86400000

# Application
NODE_ENV=development
PORT=3000
HOST=0.0.0.0
LOG_LEVEL=debug

# Email Processing
MAX_EMAILS_PER_BATCH=10
PROCESSING_TIMEOUT_SECONDS=30
RETRY_ATTEMPTS=3
QUEUE_CONCURRENCY=2

# AI Configuration
AI_CLASSIFICATION_MODEL=gpt-4o-mini
AI_EXTRACTION_MODEL=gpt-4o-mini
AI_TEMPERATURE=0.1
AI_MAX_TOKENS=2000

# Supported Formats
SUPPORTED_LANGUAGES=en,es,fr,de,pt,it,ja,zh
SUPPORTED_CURRENCIES=USD,EUR,GBP,JPY,CAD,AUD,CHF,CNY,BRL,MXN,DOP

# Development & Testing
ENABLE_REQUEST_LOGGING=true
TEST_GMAIL_ADDRESS=your-test-email@gmail.com
USE_SAMPLE_EMAILS=true
SAMPLE_EMAIL_COUNT=20

# Rate Limiting
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100

# Database Configuration
DB_CONNECTION_LIMIT=10
DB_CONNECTION_TIMEOUT=30000

# Redis Configuration
REDIS_CONNECTION_POOL_SIZE=10
REDIS_COMMAND_TIMEOUT=5000

# CORS
CORS_ORIGIN=https://your-app.railway.app
CORS_CREDENTIALS=true
```

## Deployment Process

### Automatic Deployment Flow:
1. Push code to `dev` branch
2. Railway detects changes and starts build
3. Runs `npm run build` (builds TypeScript)
4. Runs `npm run railway:start` (migrations + start server)
5. Application is live at your Railway URL

### Manual Commands (if needed):
```bash
# Database operations
npm run railway:migrate    # Run migrations
npm run railway:generate   # Generate Prisma client

# Application
npm run railway:build      # Build + generate
npm run railway:start      # Start with migrations
```

## Health Checks

The application includes health checks at:
- `GET /health` - Basic health status
- `GET /health/detailed` - Detailed service status

Railway will automatically monitor these endpoints.

## Logs and Monitoring

View logs in Railway dashboard:
1. Go to your service in Railway
2. Click "Logs" tab
3. Filter by log level if needed

## Troubleshooting

### Common Issues:

#### Build Fails
- Check that all dependencies are in `package.json`
- Verify TypeScript compiles locally: `npm run build`

#### Database Connection Errors
- Verify `DATABASE_URL` is set correctly
- Check PostgreSQL service is running in Railway

#### Redis Connection Errors
- Verify `REDIS_URL` is set correctly
- Check Redis service is running in Railway

#### Gmail API Errors
- Verify Google OAuth credentials are correct
- Check redirect URI matches Railway domain
- Ensure Gmail API is enabled in Google Cloud Console

## Next Steps

After development environment is working:
1. Create `staging` branch for staging environment
2. Create production environment from `main` branch
3. Set up custom domain
4. Configure monitoring and alerts
5. Set up backup strategies

## Cost Estimation

Railway free tier includes:
- $5 credit per month
- Covers development workloads
- PostgreSQL + Redis + App hosting

Estimated monthly cost for development: **$0-5**